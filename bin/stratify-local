#!/usr/bin/env bb
;; -*- clojure -*-
;; vim: set filetype=clojure:
#_{:clj-kondo/ignore [:namespace-name-mismatch]}
(ns stratify
  (:require
   [babashka.fs :as fs]
   [babashka.process :refer [process]]))

(defn -main [& args]
  (let [project-path (-> (fs/real-path *file*) fs/parent fs/parent)
        _ (load-file (str project-path "/bin/stratify"))
        deps-map (assoc ((resolve 'get-base-deps) project-path args)
                        'stratify/studio {:local/root (str project-path "/packages/studio")})
        deps {:aliases
              {:stratify-bin
               {:replace-deps deps-map}}}
        proc (apply process {:inherit true
                             :extra-env {"STRATIFY_PORTAL_BUNDLE_PATH" (str project-path "/packages/portal/resources/portal-dev/main.js")}}
                    "clojure" "-Sdeps" (pr-str deps)
                    "-M:stratify-bin" "-m" "stratify.main" args)]
    (System/exit (:exit @proc))))

(when (= *file* (System/getProperty "babashka.file"))
  (apply -main *command-line-args*))
